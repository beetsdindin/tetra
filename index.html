<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Tetra Element Quiz</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body class="bg-gray-100 text-gray-800 p-4">
  <div class="max-w-3xl mx-auto bg-white shadow-md rounded-xl p-6">
    <h1 class="text-2xl font-bold mb-6 text-center">üîÆ Discover Your Tetra Element Profile</h1>

    <form id="quizForm">
      <div id="quizContainer" class="space-y-8"></div>
      <div class="text-center mt-8">
        <button type="submit" class="bg-indigo-600 text-white px-6 py-2 rounded hover:bg-indigo-700">Submit</button>
      </div>
    </form>

    <div id="resultSection" class="hidden mt-10">
      <h2 class="text-xl font-semibold mb-4 text-center">üåü Your Results</h2>
      <table id="resultTable" class="w-full text-left border mb-6">
        <thead>
          <tr class="bg-gray-200">
            <th class="p-2">Element</th>
            <th class="p-2">Score</th>
          </tr>
        </thead>
        <tbody>
          <tr><td class="p-2">üåç Earth</td><td class="p-2" id="earthScore">0</td></tr>
          <tr><td class="p-2">üå¨Ô∏è Air</td><td class="p-2" id="airScore">0</td></tr>
          <tr><td class="p-2">üíß Water</td><td class="p-2" id="waterScore">0</td></tr>
          <tr><td class="p-2">üî• Fire</td><td class="p-2" id="fireScore">0</td></tr>
        </tbody>
      </table>

      <canvas id="resultChart" class="mb-4"></canvas>

      <div class="flex flex-col sm:flex-row gap-4 justify-center">
        <button onclick="downloadChart()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Download Chart as PNG</button>
        <button onclick="downloadCSV()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">Export Table as CSV</button>
      </div>
    </div>
  </div>

  <script>
    const questions = [
      ['Decisive', 'Orderly', 'Considerate', 'Spontaneous'],
      ['Results', 'Systems', 'Support', 'Inspiration'],
      ['Destination', 'Schedule', 'Journey', 'Dream'],
      ['Blunt', 'Critical', 'Hesitant', 'Easily Distracted'],
      ['Bold', 'Accurate', 'Patient', 'Enthusiastic'],
      ['Facts', 'Logic', 'Feelings', 'Possibilities'],
      ['Aggressive', 'Thorough', 'Caring', 'Sociable'],
      ['Goals', 'Quality', 'Agreement', 'Ideas'],
      ['Competitive', 'Analytical', 'Loyal', 'Optimistic'],
      ['Use It', 'Check It', 'Share It', 'Play with It']
    ];

    const elements = ['Earth', 'Air', 'Water', 'Fire'];
    const scores = { Earth: 0, Air: 0, Water: 0, Fire: 0 };

    const container = document.getElementById('quizContainer');
    questions.forEach((words, index) => {
      const shuffled = words.map((w, i) => ({ word: w, element: elements[i] }))
                            .sort(() => Math.random() - 0.5);

      const block = document.createElement('div');
      block.innerHTML = `<p class="font-medium mb-2">Q${index + 1}: Tap to assign each word a unique rank (1 = least, 4 = most like you):</p>`;

      const grid = document.createElement('div');
      grid.className = 'grid grid-cols-1 sm:grid-cols-2 gap-4';

      shuffled.forEach((item, i) => {
        const card = document.createElement('div');
        card.className = 'border rounded-lg p-4 shadow-sm bg-gray-50';

        card.innerHTML = `
          <div class="font-semibold text-lg mb-2">${item.word}</div>
          <div class="flex space-x-2">
            ${[1, 2, 3, 4].map(rank => `
              <label class="flex items-center space-x-1">
                <input type="radio" name="q${index}-${item.element}" value="${rank}" required>
                <span class="text-sm">${rank}</span>
              </label>`).join('')}
          </div>
        `;

        card.dataset.element = item.element;
        grid.appendChild(card);
      });

      block.appendChild(grid);
      container.appendChild(block);
    });

    document.getElementById('quizForm').addEventListener('submit', function(e) {
      e.preventDefault();
      Object.keys(scores).forEach(k => scores[k] = 0);

      const allInputs = document.querySelectorAll('input[type="radio"]:checked');
      const usedRanksPerQuestion = {};

      let isValid = true;
      allInputs.forEach(input => {
        const [qKey, element] = input.name.split('-');
        if (!usedRanksPerQuestion[qKey]) usedRanksPerQuestion[qKey] = new Set();
        if (usedRanksPerQuestion[qKey].has(input.value)) {
          isValid = false;
        } else {
          usedRanksPerQuestion[qKey].add(input.value);
        }
      });

      if (!isValid) {
        alert("Each rank (1‚Äì4) must be used once per question.");
        return;
      }

      allInputs.forEach(input => {
        const element = input.name.split('-')[1];
        const val = parseInt(input.value);
        scores[element] += val;
      });

      document.getElementById('earthScore').textContent = scores.Earth;
      document.getElementById('airScore').textContent = scores.Air;
      document.getElementById('waterScore').textContent = scores.Water;
      document.getElementById('fireScore').textContent = scores.Fire;

      drawChart();
      document.getElementById('resultSection').classList.remove('hidden');
      window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    });

    let chart;
    function drawChart() {
      const ctx = document.getElementById('resultChart').getContext('2d');
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: elements,
          datasets: [{
            label: 'Your Element Scores',
            data: [scores.Earth, scores.Air, scores.Water, scores.Fire],
            fill: false,
            tension: 0.3,
            borderWidth: 3
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              max: 40
            }
          }
        }
      });
    }

    function downloadChart() {
      const url = chart.toBase64Image();
      const link = document.createElement('a');
      link.href = url;
      link.download = 'element-profile.png';
      link.click();
    }

    function downloadCSV() {
      const csvData = [
        ['Element', 'Score'],
        ['Earth', scores.Earth],
        ['Air', scores.Air],
        ['Water', scores.Water],
        ['Fire', scores.Fire]
      ];
      const csv = Papa.unparse(csvData);
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      saveAs(blob, 'element-scores.csv');
    }
  </script>
</body>
</html>
